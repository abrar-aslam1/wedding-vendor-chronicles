name: Process Notification Queue

on:
  schedule:
    # Run every 5 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  process-notifications:
    runs-on: ubuntu-latest
    
    steps:
      - name: Process Notification Queue
        run: |
          echo "üîÑ Processing notification queue..."
          
          response=$(curl -s -w "%{http_code}" -X POST \
            'https://wpbdveyuuudhmwflrmqw.supabase.co/functions/v1/process-notification-queue' \
            -H 'Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwYmR2ZXl1dXVkaG13ZmxybXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4NDMyNjYsImV4cCI6MjA1MzQxOTI2Nn0.zjyA1hS9Da2tXEuUu7W44tCMGSIp2ZTpK3RpJXQdL4A' \
            -H 'Content-Type: application/json' \
            -H 'apikey: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndwYmR2ZXl1dXVkaG13ZmxybXF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzc4NDMyNjYsImV4cCI6MjA1MzQxOTI2Nn0.zjyA1hS9Da2tXEuUu7W44tCMGSIp2ZTpK3RpJXQdL4A')
          
          http_code="${response: -3}"
          response_body="${response%???}"
          
          echo "üìä HTTP Status: $http_code"
          echo "üìù Response: $response_body"
          
          if [ "$http_code" -eq 200 ]; then
            echo "‚úÖ SUCCESS: Notification queue processed successfully!"
          else
            echo "‚ùå FAILED: HTTP Status $http_code"
            echo "Response: $response_body"
            exit 1
          fi