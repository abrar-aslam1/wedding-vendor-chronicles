name: Instagram Vendor Automation - Tier 1 Backfill (Requires Approval)

on:
  schedule:
    # Run monthly on the 1st at 5 AM UTC (12 AM EST, 1 AM EDT)
    - cron: '0 5 1 * *'
  workflow_dispatch: # Allow manual triggering
    inputs:
      force_run:
        description: 'Force run without approval check (use with caution)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

jobs:
  check-approval:
    runs-on: ubuntu-latest
    outputs:
      approved: ${{ steps.approval.outputs.approved }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Check for approval
        id: approval
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          FORCE_RUN: ${{ github.event.inputs.force_run || 'false' }}
        run: |
          if [ "$FORCE_RUN" = "true" ]; then
            echo "âš ï¸  Force run enabled - skipping approval check"
            echo "approved=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create approval request using Supabase MCP (simulated for now)
          TODAY=$(date '+%Y-%m-%d')
          echo "ğŸ“… Checking approval for backfill-tier1 on $TODAY"
          
          # In production, this would check the automation_approvals table
          # For now, we'll create the approval request and wait for manual approval
          echo "Creating approval request for backfill-tier1..."
          
          # Check if already approved (this would be a real Supabase query in production)
          echo "approved=false" >> $GITHUB_OUTPUT
          
          echo "âŒ Approval required for Tier 1 backfill"
          echo "Visit your admin dashboard to approve: ${{ secrets.APP_URL }}/admin/approvals"
          
      - name: Create approval request
        if: steps.approval.outputs.approved != 'true'
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
        run: |
          TODAY=$(date '+%Y-%m-%d')
          echo "ğŸ“ Creating approval request in database for backfill-tier1"
          echo "Request details: Collect Instagram vendors from Tier 1 cities (major metros) - Expected: ~400 vendors"
          echo "Scheduled for: $TODAY"
          echo ""
          echo "ğŸ”— Admin Dashboard: ${{ secrets.APP_URL }}/admin/approvals"

  tier1-backfill:
    needs: check-approval
    if: needs.check-approval.outputs.approved == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Set up environment variables
        env:
          APP_URL: ${{ secrets.APP_URL }}
          INGEST_SHARED_KEY: ${{ secrets.INGEST_SHARED_KEY }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE: ${{ secrets.SUPABASE_SERVICE_ROLE }}
          MCP_APIFY_RPS: "1"
          MCP_APIFY_BURST: "3"
          TIER: "1"
          LIMIT_PER_ROW: "40"
          MAX_ENRICH: "400"
        run: |
          echo "APP_URL=${APP_URL}" >> $GITHUB_ENV
          echo "INGEST_SHARED_KEY=${INGEST_SHARED_KEY}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}" >> $GITHUB_ENV
          echo "SUPABASE_SERVICE_ROLE=${SUPABASE_SERVICE_ROLE}" >> $GITHUB_ENV
          echo "MCP_APIFY_RPS=${MCP_APIFY_RPS}" >> $GITHUB_ENV
          echo "MCP_APIFY_BURST=${MCP_APIFY_BURST}" >> $GITHUB_ENV
          echo "TIER=${TIER}" >> $GITHUB_ENV
          echo "LIMIT_PER_ROW=${LIMIT_PER_ROW}" >> $GITHUB_ENV
          echo "MAX_ENRICH=${MAX_ENRICH}" >> $GITHUB_ENV
          
      - name: Run Tier 1 Backfill
        run: |
          echo "ğŸš€ Starting Tier 1 cities backfill automation"
          echo "Expected to collect ~400 Instagram vendors from major metros"
          npm run play:backfill:tier
        
      - name: Log completion and stats
        run: |
          echo "âœ… Tier 1 Backfill completed at $(date)"
          echo "ğŸ“Š Check admin dashboard for results: ${{ secrets.APP_URL }}/admin/approvals"
          echo "ğŸ“ˆ New vendors should appear in your database within 30 minutes"

  notify-pending:
    needs: check-approval
    if: needs.check-approval.outputs.approved != 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Notify pending approval
        run: |
          echo "â³ Tier 1 Backfill requires approval"
          echo "ğŸ“‹ Job Details:"
          echo "   â€¢ Expected vendors: ~400"
          echo "   â€¢ Target: Tier 1 cities (NYC, LA, Chicago, etc.)"
          echo "   â€¢ Rate limit: 1 RPS (safe for production)"
          echo ""
          echo "ğŸ”— Approve at: ${{ secrets.APP_URL }}/admin/approvals"
          echo ""
          echo "âš¡ To force run (emergency only): Re-run workflow with force_run=true"
